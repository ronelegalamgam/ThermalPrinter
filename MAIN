#include <SoftwareSerial.h>
#include <StringTokenizer.h>

SoftwareSerial Thermal(10, 11);

int heatTime = 80;
int heatInterval = 255;
char printDensity = 15; 
char printBreakTime = 15;
String str_to_parse;
String dt           = "";
String str_refno    = "Ref No: ";
String foodname     = "";
String quantity     = "";
String unit_price   = "";
String sub_total    = "Amount due: ";
String cash         = "Payment: ";
String change       = "Change: ";


void setup() 
{
 Serial.begin(19200); // for debug info to serial monitor
 Thermal.begin(9600); // to write to our new printer
 initPrinter();
}

void initPrinter()
{
 //Modify the print speed and heat
 Thermal.write(27);
 Thermal.write(55);
 Thermal.write(7); //Default 64 dots = 8*('7'+1)
 Thermal.write(heatTime); //Default 80 or 800us
 Thermal.write(heatInterval); //Default 2 or 20us
 //Modify the print density and timeout
 Thermal.write(18);
 Thermal.write(35);
 int printSetting = (printDensity<<4) | printBreakTime;
 Thermal.write(printSetting); //Combination of printDensity and printBreakTime
}

void loop()
{
   if(Serial.available()){
    str_to_parse = Serial.readString();
    int i = 0;
    StringTokenizer tokens(str_to_parse, "|");
    while (tokens.hasNext()){
      if (i == 0) {
          dt += tokens.nextToken();
          i++;
        }
        if (i == 1) {
          str_refno += tokens.nextToken();
          i++;
        }
        if (i == 2) {
          foodname += tokens.nextToken();
          i++;
        }
        if (i == 3) {
          quantity += tokens.nextToken();
          i++;
        }
        if (i == 4) {
          unit_price += tokens.nextToken();
          i++;
        }
        if (i == 5) {
          sub_total += tokens.nextToken();
          i++;
        }
        if (i == 6) {
          cash += tokens.nextToken();
          i++;
        }
        if (i == 7) {
          change += tokens.nextToken();
          i++;
          break;
        }
      }
   }
   else{
      if(str_to_parse.length() > 0){
          String comb = quantity + " " + foodname + " " + unit_price + " " + sub_total; 
          Thermal.println(change); 
          Thermal.println(cash);
          Thermal.println(comb);
          Thermal.println("QTY |FOOD|UNIT PRICE|SUBTOTAL");
          Thermal.println(str_refno);
          Thermal.println(dt);
          Thermal.println("De La Sall University Dasmarinas");
          Thermal.println("Concessionaire");
          Thermal.write(10);
          Thermal.write(10);
          Thermal.write(10);
          Thermal.write(10);
     }
     reset_strings();
   }
}//end void loop();


void reset_strings(){
  str_to_parse = "";
  dt           = "";
  str_refno    = "Ref No: ";
  foodname     = "";
  quantity     = "";
  unit_price   = "";
  sub_total    = "";
  cash         = "Payment: ";
  change       = "Change: ";
}
