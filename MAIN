#include <SoftwareSerial.h>
#include <StringTokenizer.h>

const byte rxPin      = 10;
const byte txPin      = 11;
const int  timeout    = 1000;

SoftwareSerial Thermal(rxPin, txPin);

void setup() 
{
 Serial.begin(19200);   
 Serial.setTimeout(timeout);
 Thermal.begin(9600);               
 Thermal.setTimeout(timeout);
 initPrinter();
}

void initPrinter()
{
 //initialize printer
 Thermal.write(27);
 Thermal.write(64);
 delay(200);
 //charset2
 Thermal.write(27);
 Thermal.write(54);
 delay(200);
 //font
 Thermal.write(27);
 Thermal.write(87);
 Thermal.write(2);
 delay(200);
 //st gray degree
 Thermal.write(27);
 Thermal.write(109);
 Thermal.write(2);
}

void loop()
{
   if(Serial.available() > 0){
      int i=0;
      String customer            = "Customer: ";
      String tendered            = "Tendered: ";
      String orderid               = "Order ID: ";
      String dlv_loc             = "Place: ";
      String signature           = "Signature:";
      String date_and_time       = "";
      String firstname           = "";
      String lastname            = "";
      String str_to_parse        = Serial.readString();
      StringTokenizer data_sent(str_to_parse, "|");
      thermal_print(signature);
      while (data_sent.hasNext()){
          if(i == 0){
            firstname = data_sent.nextToken();
            i++;
          }
          if(i == 1){
            lastname = data_sent.nextToken();
            i++;
          }
          if(i == 2) {
            tendered += data_sent.nextToken();
            thermal_print(tendered);
            i++;
          }
          if(i == 3) {
            date_and_time = data_sent.nextToken(); //date
            i++;
          }
          if(i == 4) {
            orderid += data_sent.nextToken(); //order id
            i++;
          }
          if(i == 5){
            dlv_loc += data_sent.nextToken(); // location
            i++;
          }
          if(i == 6){
            String qty_name_st      = "";
            String food_to_parse    = "";
            int    counter          = 0;
            while(data_sent.hasNext()){
              if(counter == 0){
                qty_name_st = "Total: " + data_sent.nextToken();
                print_space();
                thermal_print(qty_name_st);
              }
              if(counter == 1){
                qty_name_st = "Price: " + data_sent.nextToken();
                thermal_print(qty_name_st);
              }
              if(counter == 2){
                qty_name_st = "Qty: " + data_sent.nextToken();
                thermal_print(qty_name_st);
                qty_name_st="";
              }
              if(counter == 3){
                  food_to_parse            = data_sent.nextToken();
                  String food_to_parse2    = food_to_parse;
                  StringTokenizer count_number_of_spaces(food_to_parse," ");
                  int num_of_spaces = 0;
                  while(count_number_of_spaces.hasNext()){
                       count_number_of_spaces.nextToken();
                       num_of_spaces++;
                  }
                  StringTokenizer number_of_words(food_to_parse2," ");
                  int num_of_print = num_of_spaces;
                  String array_of_words[num_of_print];
                  while(number_of_words.hasNext()){
                    String get_name = number_of_words.nextToken();
                    get_name.trim();
                    array_of_words[num_of_spaces-1] = get_name;
                    num_of_spaces--;
                  }
                  for(int i=0; i<num_of_print; i++){
                    thermal_print(array_of_words[i]);
                  }
                counter=-1;
              }
              counter++;
            }//end while
          }//end if(i==5)
      }//end while
      print_space();
      thermal_print(dlv_loc);
      thermal_print(lastname);
      thermal_print(firstname);
      thermal_print(customer);
      print_space();
      thermal_print(orderid);
      thermal_print(date_and_time);
      thermal_print("Oven Maid");
      thermal_print("DLSUD");
      for(int i=0; i<30; i++){
        Thermal.write(10);
        delay(80);
      } 
      clear_buffer();
   }//end if(serial.available())
}//end void loop();


void thermal_print(String s){
  Thermal.print(s);
  Thermal.write(13);
}

void clear_buffer(){
  for(int i=0; i<10; i++){
    while(Serial.available() > 0){
      char t = Serial.read();
    }
    delay(10);
  }
}

void print_space(){
  Thermal.println("");
}
